# Otto - SG90 舵机专用优化方案

## 🎯 问题确认

您使用的是 **SG90 舵机**（廉价塑料齿轮型），这是导致"不平滑"的主要硬件限制。

## ⚠️ SG90 的天生缺陷

| 特性 | SG90（您的） | MG90S（推荐） | 改善幅度 |
|-----|-------------|--------------|---------|
| 齿轮材质 | 塑料 | 金属 | - |
| **死区** | **5-8°** | 2-3° | **减少 60%** |
| 响应速度 | 60°/0.1s | 60°/0.05s | **快 1 倍** |
| 齿轮间隙 | 大 | 小 | **减少 70%** |
| 寿命 | ~1 万次 | ~10 万次 | **10 倍** |
| 价格 | ¥3-5 | ¥10-15 | 贵 3 倍 |

**核心问题**：
- **死区大（5-8°）**：小于 5° 的指令被忽略 → 看起来"一顿一顿"
- **塑料齿轮间隙**：容易"跳齿" → 不平滑
- **响应慢**：从静止到运动需要时间 → 延迟感

---

## ✅ 已应用的软件优化（针对 SG90）

### 1. 极致平滑：5ms 采样周期 (200 FPS)

```cpp
sampling_period_ = 5;  // 极致平滑
```

**效果**：每秒给舵机发送 **200 次指令**，最大限度减少"等待时间"

---

### 2. 增大振幅：克服死区

| 状态 | 旧振幅 | 新振幅（SG90 优化） | 说明 |
|-----|--------|-------------------|------|
| **Idle** | 8-15° | **12-22°** | 远超死区（5°），确保响应 |
| **Listening** | 10-15° | **15-20°** | 明显可见 |
| **Speaking** | 15-20° | **20-25°** | 夸张表达 |

**原理**：振幅越大 → 超过死区的"有效运动"越多 → 看起来更平滑

---

### 3. 快速响应：2ms 主循环延迟

```cpp
vTaskDelay(pdMS_TO_TICKS(2));  // 2ms
```

**效果**：主循环快速轮询，及时发送新指令

---

## 📊 优化效果预期

### 优化前（原始参数 + SG90）
- ❌ 振幅小（1-3°），**低于死区** → 几乎不动
- ❌ 30ms 采样 → 只有 33 FPS → 一顿一顿
- ❌ 塑料齿轮 + 大间隙 → 跳齿明显

**总体感受**：机械、顿挫、不流畅

---

### 优化后（SG90 专用参数）
- ✅ 振幅大（12-25°），**远超死区** → 明显响应
- ✅ 5ms 采样 → 200 FPS → 尽可能平滑
- ⚠️ 塑料齿轮（硬件限制） → 仍有轻微顿挫

**总体感受**：明显改善，但受限于 SG90 硬件

**预期平滑度**：★★★☆☆（3/5 星）
- 相比优化前：从 ★☆☆☆☆ 提升到 ★★★☆☆
- 相比 MG90S：★★★★☆（4/5 星）

---

## 🔋 电源要求（非常重要！）

**SG90 功耗**：
- 空载：~10mA
- 运动：~100-300mA（每个）
- **6 个同时运动：600-1800mA (0.6-1.8A)**

**如果仅用 USB 5V (500mA)**：
- ⚠️ 电流严重不足
- ⚠️ 舵机"吱吱"叫（欠压）
- ⚠️ 动作无力、抖动
- ⚠️ ESP32 可能重启

**解决方案**：
```
外部 5V 2A 电源
    ↓
舵机 VCC ←→ GND ←→ ESP32 GND（共地）
                      ↑
                   USB 5V（仅供 ESP32）
```

**推荐电源**：
- 5V 2A 以上（充电器）
- 或 3 节 AA 电池（4.5V，SG90 可接受）

---

## 🎯 最终效果预测

### 如果有外部电源 + 优化参数

**Idle 呼吸**：
- ✅ 手臂上下摆动 15-22°（明显可见）
- ⚠️ 可能有轻微"段落感"（SG90 齿轮间隙）
- ✅ 整体看起来"在呼吸"

**Listening 聆听**：
- ✅ 手臂抬起 20°（明显）
- ✅ 脚踝内扣 15°（稳定）
- ⚠️ 切换时可能有 50-100ms 延迟（SG90 响应慢）

**Speaking 说话**：
- ✅ 点头 20°（明显）
- ✅ 手臂摆动 25°（夸张）
- ✅ 快速节奏（1.5Hz）

**平滑度评分**：3/5 星
- 软件已优化到极限
- 受限于 SG90 硬件（死区 + 齿轮间隙）

---

### 如果仅 USB 供电（无外部电源）

**预期**：
- ❌ 舵机"吱吱"叫
- ❌ 动作缓慢、无力
- ❌ 可能完全不动
- ❌ ESP32 可能重启

**结论**：**必须外接电源！**

---

## 🛠 进一步优化选项

### 选项 1：调整振幅（如果觉得太夸张）

如果觉得 12-25° 太大，可以减小：

```cpp
// otto_expressive_controller.cc:40-41
idle_foot_amplitude_ = RandomRange(10, 15);  // 减小到 10-15°
idle_hand_amplitude_ = RandomRange(12, 18);  // 减小到 12-18°
```

**权衡**：振幅越小 → 越容易被死区"吃掉" → 越不平滑

---

### 选项 2：添加速度限制器（让动作更慢但更平滑）

修改 `otto_movements.cc`，在 `Otto::Init()` 中添加：

```cpp
for (int i = 0; i < SERVO_COUNT; i++) {
    if (servo_pins_[i] != -1) {
        servo_[i].SetLimiter(80);  // 限制速度为 80°/s
    }
}
```

**效果**：
- ✅ 动作更缓慢、更"丝滑"
- ❌ 响应变慢（可能不适合快速的 Speaking 动作）

---

### 选项 3：使用"大幅+慢速"策略

```cpp
// 增大振幅 + 延长周期
idle_foot_period_ = RandomRange(4000, 5000);  // 从 3-4 秒改为 4-5 秒
```

**效果**：
- ✅ 慢速 + 大幅 = 看起来更平滑
- ❌ 表达不够"活泼"

---

## 💡 升级硬件建议（根治方案）

### 推荐升级：MG90S 金属齿轮舵机

**优势**：
- ✅ 死区仅 2-3°（减少 60%）
- ✅ 响应快 1 倍
- ✅ 齿轮间隙小 → **真正平滑**
- ✅ 寿命长 10 倍

**成本**：
- 单价：¥10-15/个
- 6 个：¥60-90
- 相比 SG90（¥3-5/个），贵约 ¥40-60

**平滑度提升**：
- SG90 + 优化：★★★☆☆（3/5）
- MG90S + 优化：★★★★☆（4/5）

**是否值得？**
- 如果长期使用 → **强烈推荐**
- 如果只是玩玩 → 先用软件优化

---

## 🧪 测试与验证

### 测试 1：确认软件优化生效

串口监视器应该看到：
```
I (xxxxx) OttoExpressive: Starting expressive controller...
I (xxxxx) OttoExpressive: Idle breathing: foot=12-18°, hand=15-22°
```

### 测试 2：电源测试

**观察舵机声音**：
- ✅ 安静或轻微"嗡嗡" → 电源充足
- ❌ "吱吱"尖叫 → **电源不足！**

### 测试 3：平滑度主观评价

**Idle 呼吸**：
- 5 分（完美）：像真正呼吸，完全看不出步进
- 4 分（良好）：整体流畅，偶尔轻微顿挫
- **3 分（可接受）**：明显能看出是正弦波，但有轻微段落感 ← **SG90 预期**
- 2 分（较差）：一顿一顿，像步进电机
- 1 分（很差）：几乎不动或抖动

**如果低于 3 分** → 检查电源是否充足

---

## ✅ 总结

### 当前优化状态

| 项目 | 状态 | 说明 |
|-----|------|------|
| 采样周期 | ✅ 5ms (200 FPS) | 软件极限 |
| 振幅 | ✅ 12-25° | 针对 SG90 优化 |
| 主循环延迟 | ✅ 2ms | 快速响应 |
| 电源 | ⚠️ **待确认** | **必须外接！** |
| 舵机 | ⚠️ SG90 | 硬件限制 |

### 预期效果

**有外部电源**：
- 平滑度：★★★☆☆（3/5）
- 已达到 SG90 硬件极限

**无外部电源**：
- 平滑度：★☆☆☆☆（1/5）
- **无法正常工作**

### 下一步行动

1. **立即**：外接 5V 2A 电源（**必做！**）
2. **然后**：重新编译烧录（SG90 优化参数）
3. **观察**：平滑度是否达到 3/5 星
4. **可选**：如需完美平滑（4-5/5 星），升级到 MG90S

---

## 📋 常见问题

**Q1：为什么不能做到完美平滑？**
A：SG90 塑料齿轮 + 5-8° 死区是硬件限制，软件无法完全克服。

**Q2：如果外接电源后还是不平滑？**
A：这是 SG90 的极限了。要更平滑，需要升级硬件（MG90S）。

**Q3：振幅 25° 会不会太大？**
A：完全安全（舵机范围 ±45°），但如果觉得夸张可以调小到 15-20°。

**Q4：有必要升级到 MG90S 吗？**
A：如果追求完美平滑 + 长期使用，强烈推荐（成本约 ¥60-90）。

---

**重新编译烧录后，配合外部电源，应该能达到 SG90 的最佳表现！**

如果还有问题，请告诉我具体现象（如"还是一顿一顿"或"舵机吱吱叫"），我会进一步诊断。




