# Otto 不平滑问题诊断指南

## 🎯 问题描述

用户反馈：**动作不平滑**

需要判断是**软件问题**还是**硬件问题**。

---

## 🔍 诊断步骤

### 步骤 1：确认软件配置是否生效

通过串口监视器查看日志，确认是否看到：

```
I (xxxxx) OttoExpressive: Starting expressive controller...
I (xxxxx) OttoExpressive: Expressive controller started
I (xxxxx) OttoExpressive: State: IDLE (Breathing)
```

**如果没有这些日志** → 说明表达系统没有启动，可能是编译问题（见构建说明）

**如果有这些日志** → 继续下一步

---

### 步骤 2：检查硬件类型

**请回答以下问题**：

1. **舵机型号是什么？**
   - SG90（廉价塑料齿轮，9g）
   - MG90S（金属齿轮，9g）
   - MG996R（金属齿轮，55g）
   - 其他：______

2. **电源情况？**
   - USB 5V 供电（电流可能不足）
   - 外部 5V 电源（多少安培？）___A
   - 6V 电池供电

3. **观察到的现象是**：
   - [ ] A. 动作完全看不见（振幅太小）
   - [ ] B. 动作能看见，但一顿一顿的（像步进电机）
   - [ ] C. 动作缓慢启动，然后突然快速到位
   - [ ] D. 舵机发出"吱吱"声，抖动但不动
   - [ ] E. 其他：______

---

## 🔬 分析与解决

### 情况 A：动作完全看不见

**可能原因**：振幅优化没有生效

**解决方案**：
1. 确认重新编译了代码
2. 检查串口日志确认新代码已烧录
3. 尝试手动测试：在串口输入 MCP 命令让机器人做大动作（如 walk_forward）

---

### 情况 B：一顿一顿的（最常见）

**可能原因排查**：

#### 原因 1：软件采样周期问题（已修复）

✅ **已修复**：采样周期改为 10ms

**验证方法**：查看 `oscillator.cc:20`，应该是：
```cpp
sampling_period_ = 10;  // 降低到 10ms (100 FPS)
```

如果不是，说明没有重新编译。

---

#### 原因 2：舵机质量问题（**硬件限制**）

**廉价舵机（如 SG90）的特性**：
- ⚠️ 塑料齿轮，响应慢（60°/0.1s = 600°/s）
- ⚠️ 死区大（约 5°），小于 5° 的动作可能不响应
- ⚠️ 齿轮间隙大，容易"跳齿"

**解决方案**：

1. **软件补偿（推荐先试）**：进一步降低采样周期

修改 `oscillator.cc:20`：
```cpp
sampling_period_ = 5;  // 从 10ms 降到 5ms (200 FPS)
```

**效果**：更密集的指令，减少舵机"等待时间"

2. **增加振幅（已做）**：确保超过死区

当前振幅 8-20°，已经足够大。

3. **升级硬件**：
   - 更换 **MG90S**（金属齿轮）→ 响应更快，死区更小
   - 或 **DS3218**（数字舵机）→ 精度极高，几乎无死区

---

#### 原因 3：电源不足（**非常常见！**）

**症状**：
- 舵机"吱吱"叫
- 动作缓慢或抖动
- ESP32 频繁重启

**原因**：6 个舵机同时动作时，峰值电流可达 **2-3A**，USB 供电只有 500mA！

**解决方案**：

1. **立即测试**：外接 **5V 3A** 电源适配器到舵机供电端
   - ⚠️ 注意：ESP32 和舵机**共地**，但舵机**单独供电**

2. **推荐配置**：
   ```
   外部 5V 3A 电源 → 舵机 VCC
                   ↓
                  GND ← 共地 → ESP32 GND
   
   USB 5V → ESP32 VCC（仅供主控）
   ```

3. **验证方法**：
   - 外接电源后，舵机声音应该变"实"（不再"吱吱"叫）
   - 动作应该更有力、更快

---

#### 原因 4：PWM 分辨率问题

**当前配置**（oscillator.h:15-18）：
```cpp
#define SERVO_MIN_PULSEWIDTH_US 500   // 500us
#define SERVO_MAX_PULSEWIDTH_US 2500  // 2500us
```

**ESP32 LEDC 配置**（oscillator.cc:66）：
```cpp
.duty_resolution = LEDC_TIMER_13_BIT,  // 13位 = 8192 级
```

**计算精度**：
- 脉宽范围：2500 - 500 = 2000us
- 分辨率：2000us / 8192 = **0.24us/步**
- 角度分辨率：180° / 8192 = **0.022°/步**

**结论**：PWM 分辨率**非常高**，不是问题。

---

### 情况 C：动作缓慢启动然后突然到位

**可能原因**：舵机加速度特性

**解决方案**：添加速度限制器

修改 `otto_movements.cc` 中的 `Otto::Init()` 或构造函数：
```cpp
for (int i = 0; i < SERVO_COUNT; i++) {
    if (servo_pins_[i] != -1) {
        servo_[i].SetLimiter(100);  // 限制速度为 100°/s
    }
}
```

**注意**：这会让动作**更慢**但**更平滑**。

---

### 情况 D：舵机抖动不动

**100% 电源问题**！

**解决方案**：立即外接 5V 3A 电源。

---

## 🧪 快速测试方法

### 测试 1：单个舵机测试

添加测试代码到 `otto_controller.cc`：

```cpp
// 在 OttoController 构造函数末尾添加
ESP_LOGI(TAG, "Testing servo smoothness...");
for (int i = 0; i < 180; i++) {
    otto_.GetServo(LEFT_HAND).SetPosition(i);
    vTaskDelay(pdMS_TO_TICKS(20));  // 20ms 一步
}
ESP_LOGI(TAG, "Test complete");
```

**观察**：
- ✅ **平滑**：舵机匀速转动 180°
- ❌ **不平滑**：一顿一顿，或抖动

**如果不平滑** → 99% 是硬件问题（舵机质量或电源）

---

### 测试 2：降低采样周期到极限

修改 `oscillator.cc:20`：
```cpp
sampling_period_ = 5;  // 5ms = 200 FPS
```

**如果还不平滑** → 100% 是硬件问题

---

## 📊 总结：软件 vs 硬件判断

| 现象 | 软件问题 | 硬件问题 |
|-----|---------|---------|
| 完全没动作 | ✅ 振幅太小 | ❌ |
| 一顿一顿（5-10° 步进） | ✅ 采样周期太大 | ⚠️ 舵机死区 |
| 一顿一顿（1-2° 步进） | ❌ | ✅ 舵机质量差 |
| 舵机吱吱叫 | ❌ | ✅ 电源不足 |
| 缓慢启动后快速到位 | ❌ | ✅ 舵机加速度 |
| 抖动不动 | ❌ | ✅ 电源严重不足 |

---

## 💡 推荐解决方案（优先级排序）

### 1. 立即尝试：外接电源（最可能的问题！）

**99% 的"不平滑"问题是电源不足！**

- 外接 **5V 3A** 电源到舵机
- 共地但不共电源
- 观察是否改善

---

### 2. 软件优化：降低采样周期到 5ms

修改 `oscillator.cc:20`：
```cpp
sampling_period_ = 5;
```

**适用于**：电源充足，但舵机响应慢

---

### 3. 调整振幅：确保超过死区

如果舵机死区 5°，那么小于 5° 的振幅不会有响应。

当前振幅 8-20° 已经足够。

---

### 4. 硬件升级：更换舵机

**SG90** → **MG90S**（约 ￥15/个）
- 金属齿轮，响应快 2-3 倍
- 死区小（约 2°）
- 寿命长 10 倍

---

## 🔧 诊断清单

请按顺序检查：

- [ ] 1. 确认代码已重新编译烧录（查看串口日志）
- [ ] 2. 确认 `sampling_period_ = 10`（或 5）
- [ ] 3. **测试外接 5V 3A 电源**（最重要！）
- [ ] 4. 观察舵机是否"吱吱"叫（电源不足的标志）
- [ ] 5. 单个舵机测试（排除软件问题）
- [ ] 6. 查看舵机型号（SG90 vs MG90S）

---

## 📋 请反馈以下信息

为了准确诊断，请告诉我：

1. **舵机型号**：________
2. **供电方式**：
   - [ ] 仅 USB 5V
   - [ ] 外部电源 ___V ___A
3. **观察到的现象**（从上面情况 A-E 中选）：________
4. **串口日志**中是否看到 `OttoExpressive: Started`？：[ ] 是 [ ] 否
5. **舵机声音**：
   - [ ] 安静运行
   - [ ] "吱吱"叫（高频）
   - [ ] "嗡嗡"叫（低频）

根据您的反馈，我可以给出精准的解决方案！

---

## ⚡ 快速结论

**最可能的原因排名**：

1. **电源不足** - 占 60% 的不平滑问题
2. **舵机质量差** - 占 30%（SG90 塑料齿轮）
3. **软件采样周期** - 占 10%（已修复为 10ms）

**建议先做**：外接 5V 3A 电源测试！




