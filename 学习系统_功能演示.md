# 🎭 事件总线 + 学习系统 - 功能演示

## 📡 如何看到事件总线工作

### 启动时 - 事件监听器注册

设备启动后，您会看到：

```
I (xxx) Application: 🧠 初始化智能学习系统 (NVS存储):
I (xxx) Application:   ✅ 事件总线初始化成功
I (xxx) Application:   ✅ 用户画像加载成功 (7d互动: 0次)
I (xxx) Application:   ✅ 决策引擎初始化成功
I (xxx) Application:   ✅ 注册事件监听器: CONVERSATION_END  ← 📡 事件总线注册
I (xxx) Application: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**说明**：
- `注册事件监听器: CONVERSATION_END` 表示应用程序订阅了对话结束事件
- 当对话结束时，监听器会自动触发

---

### 对话时 - 事件发布和响应

**每次对话结束后**，您会看到：

```
I (xxx) Application: << 好的，我明白了！  ← AI 回复结束

I (xxx) UserProfile: 🧠 Learning: topic=chat, duration=5s  ← 📚 学习系统记录
I (xxx) UserProfile:   📈 Total interactions: 0 → 1      ← 互动次数增加
I (xxx) UserProfile:   ⏱️  Avg session: 0s → 5s           ← 平均时长更新
I (xxx) UserProfile:   ⭐ Favorite topic: chat            ← 最爱话题

I (xxx) Application: 📡 Event published: CONVERSATION_END  ← 📡 发布事件

I (xxx) Application: 🎧 Event received: CONVERSATION_END  ← 📡 接收事件
I (xxx) Application:   📊 User stats: 7d互动=1次, 最爱话题=chat  ← 统计信息
```

**流程说明**：
1. 🗣️  对话结束
2. 📚 `UserProfile` 记录互动数据
3. 📡 `EventBus` 发布 `CONVERSATION_END` 事件
4. 🎧 所有订阅者（包括 Application）接收事件
5. 📊 显示当前用户统计

---

## 🧠 如何看到学习系统工作

### 首次对话

```
I (xxx) UserProfile: 🧠 Learning: topic=chat, duration=5s
I (xxx) UserProfile:   📈 Total interactions: 0 → 1
I (xxx) UserProfile:   ⏱️  Avg session: 0s → 5s
I (xxx) UserProfile:   ⭐ Favorite topic: chat
```

**学到了什么**：
- 用户喜欢聊天（chat）
- 平均对话时长 5 秒

---

### 第 5 次对话

```
I (xxx) UserProfile: 🧠 Learning: topic=weather, duration=8s
I (xxx) UserProfile:   📈 Total interactions: 4 → 5
I (xxx) UserProfile:   ⏱️  Avg session: 5s → 6s
I (xxx) UserProfile:   ⭐ Favorite topic: weather  ← 话题偏好变化！
```

**学到了什么**：
- 用户问了天气相关问题
- 平均时长从 5s 增加到 6s
- **最爱话题从 chat 变成 weather**（学习系统发现用户偏好）

---

### 第 10 次对话后自动保存

```
I (xxx) UserProfile: 🧠 Learning: topic=story, duration=12s
I (xxx) UserProfile:   📈 Total interactions: 9 → 10
I (xxx) UserProfile:   ⏱️  Avg session: 6s → 7s
I (xxx) UserProfile:   ⭐ Favorite topic: weather

I (xxx) UserProfile: 💾 Auto-saved user profile  ← 自动保存到 NVS
I (xxx) UserProfile: 💾 Saved user profile to NVS (size: 200 bytes, 7d互动: 10次)
```

**学习系统做了什么**：
- 每 10 分钟或数据变化后自动保存
- 数据持久化到 NVS（设备重启也不会丢失）

---

## 🔄 重启设备后 - 数据恢复

重启设备，您会看到：

```
I (xxx) Application: 🧠 初始化智能学习系统 (NVS存储):
I (xxx) Application:   ✅ 事件总线初始化成功
I (xxx) UserProfile: ✅ Loaded user profile from NVS  ← 📥 从 NVS 加载
I (xxx) UserProfile: ========== User Profile Stats ==========
I (xxx) UserProfile: Interactions (7d): 10             ← 历史数据恢复
I (xxx) UserProfile: Avg session: 7s                   ← 平均时长恢复
I (xxx) UserProfile: Most active hour: 14:00           ← 活跃时段恢复
I (xxx) UserProfile: Favorite topic: weather           ← 话题偏好恢复
I (xxx) UserProfile: Topics: weather=5 story=2 pet=1 home=0 chat=2 other=0
I (xxx) UserProfile: ========================================
I (xxx) Application:   ✅ 用户画像加载成功 (7d互动: 10次)  ← 继续学习
```

**学习系统做了什么**：
- ✅ 从 NVS 恢复所有历史数据
- ✅ 显示详细统计信息
- ✅ 继续积累新数据

---

## 📊 学习系统记录的数据

### 1. 互动统计

```
📈 Total interactions: 0 → 1 → 2 → ... → 100
```

- 7 天内的对话总次数
- 用于判断用户活跃度

### 2. 会话时长

```
⏱️  Avg session: 5s → 6s → 7s → 10s
```

- 平均每次对话的时长
- 用于判断用户投入度

### 3. 话题偏好

```
⭐ Favorite topic: chat → weather → story
```

**话题类型**：
- `weather` - 天气查询
- `story` - 讲故事
- `pet` - 电子宠物
- `smart_home` - 智能家居控制
- `chat` - 闲聊
- `other` - 其他

**例如**：
```
I (xxx) UserProfile: Topics: weather=15 story=8 pet=5 home=3 chat=10 other=2
                                ↑ 最多    ↑ 第二  ↑ 第三
```

用户最喜欢问天气（15次），其次是讲故事（8次）

### 4. 活跃时段

```
I (xxx) UserProfile: Most active hour: 14:00
```

- 记录用户在一天中哪个时段最活跃
- 用于个性化推荐（例如下午主动提醒天气）

---

## 🎯 实际使用示例

### 场景 1：早上问天气

**用户**："今天天气怎么样？"

**日志**：
```
I (xxx) Application: >> 今天天气怎么样？
I (xxx) Application: << 今天北京晴天，气温15-25度

I (xxx) UserProfile: 🧠 Learning: topic=weather, duration=3s
I (xxx) UserProfile:   📈 Total interactions: 5 → 6
I (xxx) UserProfile:   ⏱️  Avg session: 4s → 4s
I (xxx) UserProfile:   ⭐ Favorite topic: weather

I (xxx) Application: 📡 Event published: CONVERSATION_END
I (xxx) Application: 🎧 Event received: CONVERSATION_END
I (xxx) Application:   📊 User stats: 7d互动=6次, 最爱话题=weather
```

**系统学到**：
- 用户喜欢问天气（weather 计数 +1）
- 早上 9 点活跃（更新时段统计）

---

### 场景 2：晚上让宠物玩耍

**用户**："陪小猫玩一会儿"

**日志**：
```
I (xxx) Application: >> 陪小猫玩一会儿
I (xxx) Pet: 🎾 玩耍: 心情 70 → 85

I (xxx) UserProfile: 🧠 Learning: topic=pet, duration=2s
I (xxx) UserProfile:   📈 Total interactions: 6 → 7
I (xxx) UserProfile:   ⏱️  Avg session: 4s → 3s
I (xxx) UserProfile:   ⭐ Favorite topic: weather  ← 仍然是天气（因为 weather=6, pet=1）

I (xxx) Application: 📡 Event published: CONVERSATION_END
I (xxx) Application: 🎧 Event received: CONVERSATION_END
I (xxx) Application:   📊 User stats: 7d互动=7次, 最爱话题=weather
```

**系统学到**：
- 用户也喜欢宠物功能（pet 计数 +1）
- 晚上 20 点活跃（更新时段统计）

---

### 场景 3：连续问了 10 次天气后

```
I (xxx) UserProfile: Topics: weather=15 story=2 pet=3 chat=5 other=0
I (xxx) UserProfile:   ⭐ Favorite topic: weather  ← 明显偏好天气

I (xxx) DecisionEngine: 🎯 决策建议: 主动推荐天气功能
I (xxx) DecisionEngine:    理由: 用户天气话题占比 60% (15/25)
```

**决策引擎建议**：
- 可以在 AI 提示词中加入："用户经常问天气，可以主动提醒天气变化"
- 或者在特定时间（如早上 9 点）主动推送天气

---

## 🔧 如何测试

### 测试 1：对话 5 次，观察学习过程

1. 唤醒小智
2. 说 5 句不同的话
3. 观察日志中的 `🧠 Learning` 信息
4. 看到 `📈 Total interactions: 0 → 1 → 2 → 3 → 4 → 5`

### 测试 2：重启设备，验证数据持久化

1. 对话 10 次
2. 重启设备
3. 观察启动日志：
   ```
   I (xxx) UserProfile: Interactions (7d): 10  ← 数据恢复成功
   ```

### 测试 3：观察事件总线工作

1. 对话 1 次
2. 观察日志：
   ```
   📡 Event published: CONVERSATION_END  ← 发布
   🎧 Event received: CONVERSATION_END   ← 接收
   ```

---

## 📈 长期使用效果

### 1 天后

```
I (xxx) UserProfile: Interactions (7d): 25
I (xxx) UserProfile: Avg session: 8s
I (xxx) UserProfile: Most active hour: 14:00
I (xxx) UserProfile: Favorite topic: weather
```

### 7 天后

```
I (xxx) UserProfile: Interactions (7d): 150
I (xxx) UserProfile: Avg session: 12s
I (xxx) UserProfile: Most active hour: 14:00
I (xxx) UserProfile: Favorite topic: weather
I (xxx) UserProfile: Topics: weather=80 story=30 pet=20 home=10 chat=10
I (xxx) UserProfile: Positive ratio: 85%  ← 85% 的反馈是正面的
```

**系统了解用户**：
- 非常活跃（150 次对话）
- 喜欢问天气（80 次，占 53%）
- 下午 2 点最活跃
- 平均对话 12 秒（投入度高）
- 85% 正面反馈（体验良好）

---

## ✅ 总结

### 事件总线功能体现

| 时机 | 日志标识 | 说明 |
|------|---------|------|
| 启动时 | `✅ 注册事件监听器: CONVERSATION_END` | 订阅事件 |
| 对话结束 | `📡 Event published: CONVERSATION_END` | 发布事件 |
| 事件响应 | `🎧 Event received: CONVERSATION_END` | 接收事件 |
| 显示统计 | `📊 User stats: 7d互动=X次` | 事件处理 |

### 学习系统功能体现

| 数据 | 日志标识 | 说明 |
|------|---------|------|
| 记录互动 | `🧠 Learning: topic=X, duration=Ys` | 实时学习 |
| 互动次数 | `📈 Total interactions: A → B` | 统计累积 |
| 平均时长 | `⏱️  Avg session: As → Bs` | 时长学习 |
| 话题偏好 | `⭐ Favorite topic: X` | 偏好识别 |
| 数据保存 | `💾 Saved user profile to NVS` | 持久化 |
| 数据恢复 | `✅ Loaded user profile from NVS` | 重启恢复 |

**所有功能都在日志中清晰可见！** 🎉

