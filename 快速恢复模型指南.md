# 🚀 快速恢复 VADNet1 + NSNet2 模型

## ✅ 检测结果

- 📦 模型文件：**已存在** `build/srmodels/srmodels.bin` (896KB)
- 📍 设备串口：**已找到** `/dev/tty.usbmodem101`
- 🎯 目标地址：`0x800000` (model分区)

包含的模型：
- ✅ **nsnet2** - 神经网络降噪
- ✅ **vadnet1_medium** - 神经网络VAD
- ✅ **wn9_nihaoxiaozhi_tts** - 唤醒词

---

## 🎯 方法1：VSCode一键恢复（最简单）⭐

### 步骤：

1. **打开VSCode** - 确保已安装 ESP-IDF 插件

2. **在底部工具栏找到ESP-IDF图标**

3. **选择设备串口**：
   - 点击底部的串口选择器
   - 选择 `/dev/tty.usbmodem101`

4. **烧录**：
   - 方式A：完整烧录（推荐）
     - 按 `Cmd+Shift+P`
     - 输入 `ESP-IDF: Flash your project`
     - 回车
   
   - 方式B：只烧录模型分区
     - 按 `Cmd+Shift+P`
     - 输入 `ESP-IDF: Flash (Custom Partitions)`
     - 选择 `model` 分区

5. **等待完成** - 看到 "Flash complete" 即可

6. **重启设备** - 断电重连或按复位键

---

## 🔧 方法2：使用终端命令

### 步骤1：在VSCode中打开终端

```bash
# VSCode 菜单: Terminal -> New Terminal
# 或快捷键: Ctrl+`
```

### 步骤2：激活ESP-IDF环境

在VSCode的ESP-IDF终端中，环境已自动激活。直接运行：

```bash
esptool.py -p /dev/tty.usbmodem101 write_flash 0x800000 build/srmodels/srmodels.bin
```

或者完整烧录：

```bash
idf.py -p /dev/tty.usbmodem101 flash
```

---

## 📊 验证恢复成功

烧录完成后，在VSCode中打开串口监控：

```bash
idf.py -p /dev/tty.usbmodem101 monitor
```

或使用VSCode的ESP-IDF Monitor功能。

### 成功标志：

在日志中查找：

```
I (xxxx) AfeAudioProcessor: 📦 Flash 中的模型数量: 3       ← 从 0 变成 3
I (xxxx) AfeAudioProcessor: ✅ ESP-SR 加载的模型数量: 3
I (xxxx) AfeAudioProcessor:    ESP-SR 模型 0: wn9_nihaoxiaozhi_tts
I (xxxx) AfeAudioProcessor:    ESP-SR 模型 1: vadnet1_medium    ← VAD恢复
I (xxxx) AfeAudioProcessor:    ESP-SR 模型 2: nsnet2            ← 降噪恢复
I (xxxx) AfeAudioProcessor: ✅ VAD 人声检测: VADNet1 (神经网络)   ← 不再是WebRTC
I (xxxx) AfeAudioProcessor: ✅ 使用 ESP-SR 神经网络降噪: nsnet2  ← 不再是禁用
```

**不再看到这些警告**：
```
W (xxxx) AfeAudioProcessor: ⚠️  未找到 vadnet1_medium  ← 消失
W (xxxx) AfeAudioProcessor: ⚠️  未找到 NS 降噪模型     ← 消失
```

---

## 🎉 恢复完成后的效果

### Before（当前）：
```
I (xxxx) 📦 Flash 中的模型数量: 0
I (xxxx) ✅ VAD 人声检测: WebRTC 模式
W (xxxx) ⚠️  未找到 NS 降噪模型，降噪已禁用
```

### After（恢复后）：
```
I (xxxx) 📦 Flash 中的模型数量: 3
I (xxxx) ✅ VAD 人声检测: VADNet1 (神经网络)
I (xxxx) ✅ 使用 ESP-SR 神经网络降噪: nsnet2
```

---

## ⚡ 快捷命令（复制粘贴）

### 在VSCode的ESP-IDF终端中：

```bash
# 方法A：只烧录模型（快速，保留其他数据）
esptool.py -p /dev/tty.usbmodem101 write_flash 0x800000 build/srmodels/srmodels.bin

# 方法B：完整烧录（彻底，会重置所有数据）
idf.py -p /dev/tty.usbmodem101 flash

# 方法C：使用idf.py烧录（推荐）
idf.py -p /dev/tty.usbmodem101 flash

# 烧录后监控
idf.py -p /dev/tty.usbmodem101 monitor
```

---

## 🔍 故障排除

### 问题1：串口找不到设备

```bash
# 重新查找串口
ls /dev/tty.*
```

如果看到其他USB设备（如 `/dev/tty.usbserial-XXXX`），用那个串口。

### 问题2：权限被拒绝

```bash
# macOS需要给VSCode串口权限
# 系统偏好设置 -> 安全性与隐私 -> 隐私 -> 完全磁盘访问权限
# 添加VSCode
```

### 问题3：设备忙

```bash
# 关闭其他可能占用串口的程序
# 如：Arduino IDE、Serial Monitor等
```

---

## 📝 注意事项

1. **完整烧录** (`idf.py flash`)：
   - ✅ 恢复所有模型
   - ✅ 更新固件
   - ⚠️  会清除WiFi配置
   - ⚠️  会清除用户画像数据（但学习系统会自动重建）

2. **只烧录模型** (`esptool.py ... 0x800000 ...`)：
   - ✅ 只恢复模型
   - ✅ 保留WiFi配置
   - ✅ 保留用户画像数据
   - ⚠️  需要手动指定地址

**推荐**：使用 `idf.py flash` 完整烧录，最稳妥！

---

**准备好了吗？现在就在VSCode中试试吧！** 🚀

有问题随时告诉我！























