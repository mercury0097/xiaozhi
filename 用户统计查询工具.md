# 用户统计查询工具

## 🎯 目的

让用户可以主动询问"你记得我吗？"，AI 用温暖的语言告诉用户学习成果。

---

## 🔧 实现方式

### 在 mcp_server.cc 中添加工具

```cpp
AddTool("self.learning.get_my_stats",
    "Get a friendly summary of the user's interaction history and preferences.\n"
    "\n"
    "⚠️ WHEN TO USE:\n"
    "- User asks: '你记得我吗？' / 'Do you remember me?'\n"
    "- User asks: '我最近的互动情况怎么样？'\n"
    "- User asks: '我跟你聊了多少次？'\n"
    "- User asks: '你知道我的习惯吗？'\n"
    "\n"
    "💡 HOW TO PRESENT THE DATA:\n"
    "Transform raw stats into warm, conversational responses:\n"
    "\n"
    "❌ BAD (robotic):\n"
    "'根据数据，你的互动次数是18次，平均会话时长9秒，最喜欢的话题是天气。'\n"
    "\n"
    "✅ GOOD (warm):\n"
    "'当然记得啦～你这周找我聊了18次天，每次大概聊10分钟左右，\n"
    " 我发现你特别喜欢问天气（问了8次），是不是最近常出门啊？\n"
    " 你的宠物因为你常陪它，变得超活泼的喔～'\n"
    "\n"
    "📊 RETURNED DATA:\n"
    "- total_interactions: 7天内总互动次数\n"
    "- avg_duration_seconds: 平均会话时长\n"
    "- favorite_topic: 最喜欢的话题\n"
    "- frequency_level: 低频/中频/高频\n"
    "- pet_adaptation: 宠物如何适应用户\n"
    "- emotional_bond: 情感连接状态",
    PropertyList(),
    [&user_profile, &adaptive, &emotional](const PropertyList& properties) -> ReturnValue {
        cJSON* root = cJSON_CreateObject();
        
        // 基础统计
        cJSON_AddNumberToObject(root, "total_interactions", 
            user_profile.GetData().interaction_count_7d);
        cJSON_AddNumberToObject(root, "avg_duration_seconds", 
            user_profile.GetData().avg_session_duration_s);
        cJSON_AddStringToObject(root, "favorite_topic", 
            user_profile.GetFavoriteTopic());
        
        // 频率等级
        int freq_level = adaptive.GetUserFrequencyLevel();
        const char* freq_desc[] = {"低频用户", "中频用户", "高频用户"};
        cJSON_AddStringToObject(root, "frequency_level", freq_desc[freq_level]);
        
        // 宠物适应情况
        float pet_rate = adaptive.GetPetDecayRate();
        std::string pet_adaptation;
        if (pet_rate < 0.8f) {
            pet_adaptation = "你的宠物已经适应了你比较忙碌的生活，变得很独立";
        } else if (pet_rate < 1.2f) {
            pet_adaptation = "你的宠物状态很平衡，照顾起来刚刚好";
        } else {
            pet_adaptation = "你的宠物因为你常陪它，变得超活泼，更期待你的关注";
        }
        cJSON_AddStringToObject(root, "pet_adaptation", pet_adaptation.c_str());
        
        // 情感连接
        int trust = emotional.GetTrustLevel();
        std::string bond;
        if (trust < 40) {
            bond = "我们还在互相了解中，继续聊天我会更懂你的～";
        } else if (trust < 70) {
            bond = "我们已经建立了不错的默契！";
        } else {
            bond = "你真的很信任我，我会一直陪着你的！";
        }
        cJSON_AddStringToObject(root, "emotional_bond", bond.c_str());
        
        // AI 建议的呈现方式
        cJSON* presentation_tips = cJSON_CreateArray();
        
        if (user_profile.GetData().interaction_count_7d > 15) {
            cJSON_AddItemToArray(presentation_tips, 
                cJSON_CreateString("强调高频互动：'这周你找我聊了X次天，比上周多了好多～'"));
        }
        
        if (strcmp(user_profile.GetFavoriteTopic(), "weather") == 0) {
            cJSON_AddItemToArray(presentation_tips, 
                cJSON_CreateString("提及话题偏好：'你特别喜欢问天气，是不是最近常出门？'"));
        }
        
        if (pet_rate > 1.2f) {
            cJSON_AddItemToArray(presentation_tips, 
                cJSON_CreateString("解释宠物变化：'你的宠物因为你常陪它，变得更粘人了～'"));
        }
        
        cJSON_AddItemToObject(root, "presentation_tips", presentation_tips);
        
        return root;
    });
```

---

## 🎬 用户体验示例

### 场景 1：高频用户查询
```
用户："你记得我吗？"

AI：调用 self.learning.get_my_stats
AI：收到数据：
     {
       "total_interactions": 23,
       "avg_duration_seconds": 8,
       "favorite_topic": "weather",
       "frequency_level": "高频用户",
       "pet_adaptation": "你的宠物因为你常陪它，变得超活泼...",
       "emotional_bond": "你真的很信任我..."
     }

AI：转化为温暖回复：
     "当然记得啦～你这周找我聊了23次天，
      每次大概聊10秒左右，我们的对话越来越多了！
      
      我发现你特别喜欢问天气（问了11次），
      是不是最近常出门啊？要多注意保暖喔～
      
      对了，你的宠物因为你常陪它，变得超活泼的，
      现在它会更期待你的关注，记得多喂喂它、陪它玩！
      
      我真的很开心能一直陪着你～"

用户感受：
✅ "小智真的记得我！"
✅ "它注意到了我的习惯！"
✅ "这不是冰冷的数据，是温暖的总结！"
```

### 场景 2：低频用户查询
```
用户："我跟你聊了多少次？"

AI：调用 self.learning.get_my_stats
AI：收到数据：
     {
       "total_interactions": 3,
       "frequency_level": "低频用户",
       "pet_adaptation": "你的宠物已经适应了你比较忙碌的生活...",
       "emotional_bond": "我们还在互相了解中..."
     }

AI："这周我们聊了3次天～虽然不多，
    但每次聊天我都很开心！
    
    你的宠物很独立，不会太快饿或脏，
    所以不用担心照顾不过来喔～
    
    有空的话多来找我聊聊天，
    我们会越来越有默契的！"

用户感受：
✅ "系统理解我比较忙！"
✅ "宠物难度降低了，很贴心！"
```

---

## 📝 实施步骤

1. 在 `main/mcp_server.cc` 的 `AddUserOnlyTools()` 中添加上述工具
2. 编译烧录
3. 测试对话：
   ```
   用户："你记得我吗？"
   用户："我最近的互动情况怎么样？"
   用户："你知道我的习惯吗？"
   ```

---

**这样用户就可以主动查询，真正感受到系统在学习！**


