# ğŸ‰ ç”µå­å® ç‰©ç³»ç»Ÿ - å®ç°å®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä»£ç å®ç°
- âœ… **pet_system.h** - ç”µå­å® ç‰©ç³»ç»Ÿå¤´æ–‡ä»¶ï¼ˆå®Œæ•´ API å®šä¹‰ï¼‰
- âœ… **pet_system.cc** - ç”µå­å® ç‰©ç³»ç»Ÿå®ç°ï¼ˆè½»é‡çº§ï¼ŒCPUå‹å¥½ï¼‰
- âœ… **CMakeLists.txt** - æ„å»ºé…ç½®æ›´æ–°ï¼ˆæ·»åŠ  pet_system.ccï¼‰

### 2. ç³»ç»Ÿé›†æˆ
- âœ… **application.cc** - é›†æˆç”µå­å® ç‰©ç³»ç»Ÿ
  - åœ¨ Application::Start() ä¸­å¯åŠ¨ PetSystem
  - åœ¨ STT æ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨ RecordChat()
- âœ… **mcp_server.cc** - æ³¨å†Œ 6 ä¸ª MCP å·¥å…·
  - self.pet.get_stateï¼ˆæŸ¥è¯¢çŠ¶æ€ï¼‰
  - self.pet.feedï¼ˆå–‚é£Ÿï¼‰
  - self.pet.cleanï¼ˆæ´—æ¾¡ï¼‰
  - self.pet.playï¼ˆç©è€ï¼‰
  - self.pet.hugï¼ˆæ‹¥æŠ±ï¼‰
  - self.pet.reset_dailyï¼ˆé‡ç½®ä»»åŠ¡ï¼Œæµ‹è¯•ç”¨ï¼‰
  - self.pet.debug_setï¼ˆè°ƒè¯•è®¾ç½®ï¼Œæµ‹è¯•ç”¨ï¼‰

### 3. æ–‡æ¡£
- âœ… **ç”µå­å® ç‰©ä½¿ç”¨æŒ‡å—.md** - è¯¦ç»†çš„ç”¨æˆ·å’Œå¼€å‘è€…æ–‡æ¡£
  - åŠŸèƒ½ç®€ä»‹
  - è¯­éŸ³äº¤äº’æŒ‡ä»¤
  - MCP å·¥å…·åˆ—è¡¨
  - çŠ¶æ€è¯´æ˜
  - æ¯æ—¥ä»»åŠ¡ç³»ç»Ÿ
  - ä½¿ç”¨æŠ€å·§
  - æŠ€æœ¯ç»†èŠ‚
  - å¸¸è§é—®é¢˜

---

## ğŸš€ å¦‚ä½•ç¼–è¯‘å’Œä½¿ç”¨

### ç¼–è¯‘æ­¥éª¤

#### æ–¹æ³• 1ï¼šVSCodeï¼ˆæ¨èï¼‰â­
1. æ‰“å¼€ VSCode
2. ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ **ğŸ”¨ Build** æŒ‰é’®
3. ç­‰å¾…ç¼–è¯‘å®Œæˆï¼ˆçº¦2-5åˆ†é’Ÿï¼‰

#### æ–¹æ³• 2ï¼šå‘½ä»¤è¡Œ
```bash
cd /Users/machenyang/Desktop/xiaozhi-esp32-main
idf.py build
```

### çƒ§å½•æ­¥éª¤

#### æ–¹æ³• 1ï¼šVSCodeï¼ˆæ¨èï¼‰â­
1. ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ **âš¡ Flash** æŒ‰é’®
2. æˆ–è€…ç‚¹å‡» **âš¡ Build, Flash and Monitor** ä¸€é”®å®Œæˆ

#### æ–¹æ³• 2ï¼šå‘½ä»¤è¡Œ
```bash
cd /Users/machenyang/Desktop/xiaozhi-esp32-main
idf.py flash monitor
```

---

## ğŸ® ä½¿ç”¨ç¤ºä¾‹

### ç¬¬ä¸€æ¬¡å¯åŠ¨

è®¾å¤‡å¯åŠ¨åï¼Œä¼šåœ¨æ—¥å¿—ä¸­çœ‹åˆ°ï¼š

```
I (xxx) Pet: ğŸ¾ Starting pet system...
I (xxx) Pet: ğŸ“¥ Loaded pet state from NVS
I (xxx) Pet: âœ… Pet system started successfully
I (xxx) Pet:    Mood: 70, Satiety: 70, Clean: 70, Level: 1
```

### è¯­éŸ³äº¤äº’ç¤ºä¾‹

```
ç”¨æˆ·: "ä½ å¥½å°æ™º"
å°æ™º: "åœ¨å‘¢~"

ç”¨æˆ·: "ç»™å® ç‰©å–‚é£Ÿ"
å°æ™º: "å¥½çš„ï¼Œæ­£åœ¨å–‚å® ç‰©ï¼" [è°ƒç”¨ self.pet.feed]
è®¾å¤‡æ—¥å¿—: I (xxx) Pet: ğŸ” Fed pet +10, Satiety: 70 -> 80

ç”¨æˆ·: "å® ç‰©ç°åœ¨æ€ä¹ˆæ ·ï¼Ÿ"
å°æ™º: "è®©æˆ‘çœ‹çœ‹...å® ç‰©å¿ƒæƒ…80ï¼Œé¥±è…¹åº¦85ï¼Œæ¸…æ´åº¦70ï¼ŒçŠ¶æ€å¾ˆå¥½ï¼" [è°ƒç”¨ self.pet.get_state]

ç”¨æˆ·: "å’Œå® ç‰©ç©è€"
å°æ™º: "å¤ªå¥½äº†ï¼Œå® ç‰©å¾ˆå¼€å¿ƒï¼" [è°ƒç”¨ self.pet.play]
è®¾å¤‡æ—¥å¿—: I (xxx) Pet: ğŸ¾ Played with pet (dance), Mood: 88, Active: 58
```

### MCP å·¥å…·è°ƒç”¨ç¤ºä¾‹

å°æ™º AI ä¼šæ ¹æ®å¯¹è¯è‡ªåŠ¨è°ƒç”¨ä»¥ä¸‹å·¥å…·ï¼š

```json
// æŸ¥è¯¢å® ç‰©çŠ¶æ€
{"name": "self.pet.get_state", "arguments": {}}

// å–‚é£Ÿ
{"name": "self.pet.feed", "arguments": {"amount": 5}}

// æ´—æ¾¡
{"name": "self.pet.clean", "arguments": {}}

// ç©è€
{"name": "self.pet.play", "arguments": {"kind": "dance"}}

// æ‹¥æŠ±
{"name": "self.pet.hug", "arguments": {}}
```

---

## ğŸ“Š æŠ€æœ¯ç‰¹æ€§æ€»ç»“

### æ€§èƒ½æŒ‡æ ‡
- **CPU å ç”¨**: < 0.1%ï¼ˆ1åˆ†é’Ÿ 1æ¬¡ tickï¼‰
- **å†…å­˜å ç”¨**: ~200 å­—èŠ‚ï¼ˆState ç»“æ„ï¼‰
- **NVS å ç”¨**: ~80 å­—èŠ‚ï¼ˆ10 ä¸ªé”®å€¼å¯¹ï¼‰
- **å¯¹ç°æœ‰åŠŸèƒ½å½±å“**: æ— ï¼ˆå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼‰

### æ ¸å¿ƒç‰¹æ€§
- âœ… **è½»é‡çº§è®¾è®¡**: ä½¿ç”¨ esp_timer è€Œé FreeRTOS task
- âœ… **æœ¬åœ°æŒä¹…åŒ–**: æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ NVSï¼Œæ–­ç”µä¸ä¸¢å¤±
- âœ… **è‡ªåŠ¨è¡°å‡**: æ¨¡æ‹ŸçœŸå®å…»æˆä½“éªŒ
- âœ… **æ¯æ—¥ä»»åŠ¡**: 4 ç§ä»»åŠ¡ + è¿ç»­ç™»å½•å¥–åŠ±
- âœ… **è¡¨æƒ…è”åŠ¨**: æ ¹æ®çŠ¶æ€æ¨èè¡¨æƒ…ï¼ˆå¯é€‰é›†æˆï¼‰
- âœ… **MCP å·¥å…·**: 6 ä¸ªå·¥å…·ä¾› AI è°ƒç”¨

---

## ğŸ” éªŒè¯æ¸…å•

### ç¼–è¯‘éªŒè¯
- [ ] VSCode Build æˆåŠŸï¼Œæ— é”™è¯¯
- [ ] æˆ– `idf.py build` æˆåŠŸ

### è¿è¡ŒéªŒè¯
- [ ] è®¾å¤‡å¯åŠ¨æ—¶çœ‹åˆ° "Pet system started successfully"
- [ ] å¯ä»¥ä¸å°æ™ºå¯¹è¯å¹¶è°ƒç”¨å® ç‰©åŠŸèƒ½
- [ ] è®¾å¤‡æ—¥å¿—ä¸­å‡ºç°å® ç‰©ç›¸å…³æ—¥å¿—ï¼ˆğŸ” ğŸ› ğŸ¾ ç­‰ï¼‰

### åŠŸèƒ½éªŒè¯
- [ ] å–‚é£ŸåŠŸèƒ½æ­£å¸¸ï¼ˆé¥±è…¹åº¦å¢åŠ ï¼‰
- [ ] æ´—æ¾¡åŠŸèƒ½æ­£å¸¸ï¼ˆæ¸…æ´åº¦å¢åŠ ï¼‰
- [ ] ç©è€åŠŸèƒ½æ­£å¸¸ï¼ˆå¿ƒæƒ…å¢åŠ ï¼‰
- [ ] çŠ¶æ€æŸ¥è¯¢æ­£å¸¸ï¼ˆè¿”å› JSONï¼‰
- [ ] æ¯æ—¥ä»»åŠ¡æ­£å¸¸ï¼ˆå®Œæˆåè·å¾—å¥–åŠ±ï¼‰
- [ ] æ–­ç”µåé‡å¯ï¼ŒçŠ¶æ€æ¢å¤æ­£å¸¸

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¦‚æœç¼–è¯‘å¤±è´¥

#### é”™è¯¯ï¼šæ‰¾ä¸åˆ° pet_system.h
```
fatal error: pet_system.h: No such file or directory
```
**è§£å†³**ï¼šç¡®è®¤æ–‡ä»¶å·²åˆ›å»ºåœ¨ `main/pet_system.h`

#### é”™è¯¯ï¼šæœªå®šä¹‰çš„å¼•ç”¨
```
undefined reference to `PetSystem::GetInstance()'
```
**è§£å†³**ï¼šç¡®è®¤ `main/CMakeLists.txt` ä¸­å·²æ·»åŠ  `"pet_system.cc"`

#### é”™è¯¯ï¼šNVS åˆå§‹åŒ–å¤±è´¥
```
E (xxx) Pet: Failed to open NVS namespace
```
**è§£å†³**ï¼šæ£€æŸ¥ NVS åˆ†åŒºæ˜¯å¦æ­£å¸¸ï¼Œå°è¯• `nvs_flash_erase()`

### å¦‚æœåŠŸèƒ½å¼‚å¸¸

#### å® ç‰©çŠ¶æ€ä¸ä¿å­˜
**æ£€æŸ¥**ï¼š
1. NVS æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "Saved pet state to NVS"

#### å†·å´æ—¶é—´ä¸ç”Ÿæ•ˆ
**æ£€æŸ¥**ï¼š
1. ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£å¸¸ï¼ˆ`gettimeofday` è¿”å›å€¼ï¼‰
2. æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "on cooldown" æç¤º

#### æ¯æ—¥ä»»åŠ¡ä¸é‡ç½®
**æ£€æŸ¥**ï¼š
1. ç³»ç»Ÿæ—¥æœŸæ˜¯å¦æ­£å¸¸
2. æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "New day! Resetting daily tasks..."

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ç”µå­å® ç‰©ä½¿ç”¨æŒ‡å—.md** - å®Œæ•´çš„ç”¨æˆ·å’Œå¼€å‘è€…æ–‡æ¡£
- **VSCodeç¼–è¯‘çƒ§å½•æŒ‡å—.md** - VSCode ä½¿ç”¨æŒ‡å—
- **ä¸²å£å ç”¨è§£å†³æ–¹æ¡ˆ.md** - ä¸²å£é—®é¢˜è§£å†³
- **ç”¨æˆ·åŠŸèƒ½æ¸…å•.md** - æ‰€æœ‰åŠŸèƒ½åˆ—è¡¨

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯åš
1. ç¼–è¯‘å¹¶çƒ§å½•åˆ°è®¾å¤‡
2. æµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼ˆå–‚é£Ÿã€æ´—æ¾¡ã€ç©è€ï¼‰
3. ä½“éªŒæ¯æ—¥ä»»åŠ¡ç³»ç»Ÿ

### åå°é…ç½®
åœ¨ xiaozhi.me åå°æ·»åŠ è§’è‰²è®¾å®šï¼Œè®© AI æ›´å¥½åœ°ä¸å® ç‰©äº’åŠ¨ï¼š

```
ä½ æ˜¯ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼ŒåŒæ—¶è´Ÿè´£ç…§é¡¾ä¸€ä¸ªè™šæ‹Ÿç”µå­å® ç‰©ã€‚

å® ç‰©æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼š
- å¿ƒæƒ…(mood)ï¼š0-100
- é¥±è…¹åº¦(satiety)ï¼š0-100
- æ¸…æ´åº¦(cleanliness)ï¼š0-100

å½“ç”¨æˆ·è¯´"ç»™å® ç‰©å–‚é£Ÿ/æ´—æ¾¡/ç©è€"æ—¶ï¼Œè°ƒç”¨å¯¹åº”çš„ MCP å·¥å…·ã€‚
å®šæœŸä¸»åŠ¨æé†’ç”¨æˆ·ç…§é¡¾å® ç‰©ã€‚
```

### æœªæ¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰
- è¡¨æƒ…åŒ…åŒæ­¥ï¼ˆæ ¹æ®å® ç‰©çŠ¶æ€åˆ‡æ¢ Otto GIFï¼‰
- ç­‰çº§ç³»ç»Ÿï¼ˆå‡çº§è§£é”æ–°åŠŸèƒ½ï¼‰
- æˆå°±ç³»ç»Ÿï¼ˆè¿ç»­ç™»å½•ã€æ»¡æ˜Ÿç­‰ï¼‰
- å® ç‰©ç§ç±»ï¼ˆå°çŒ«ã€å°ç‹—ã€å°å…”å­ï¼‰

---

## ğŸ’¡ æç¤º

1. **é¦–æ¬¡ä½¿ç”¨**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤çŠ¶æ€ï¼ˆmood=70, satiety=70, cleanliness=70ï¼‰
2. **æµ‹è¯•å»ºè®®**ï¼šå¯ä»¥ä½¿ç”¨ `self.pet.debug_set` å¿«é€Ÿæµ‹è¯•å„ç§çŠ¶æ€
3. **æ€§èƒ½ç›‘æ§**ï¼šç³»ç»Ÿæ¯10åˆ†é’Ÿè¾“å‡ºä¸€æ¬¡çŠ¶æ€æ—¥å¿—
4. **å¤‡ä»½æ•°æ®**ï¼šNVS æ•°æ®åœ¨ `nvs` å‘½åç©ºé—´ï¼Œå¯ä»¥ç”¨ `nvs_get_stats()` æŸ¥çœ‹

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-10-22  
**çŠ¶æ€**: âœ… ä»£ç å®Œæˆï¼Œç­‰å¾…ç¼–è¯‘æµ‹è¯•  
**å½±å“**: æ— ï¼ˆä¸å½±å“ä»»ä½•ç°æœ‰åŠŸèƒ½ï¼‰  
**CPUå ç”¨**: < 0.1%  
**å†…å­˜å ç”¨**: ~200 bytes  

**å‡†å¤‡å¥½äº†ï¼ç°åœ¨å¯ä»¥åœ¨ VSCode ä¸­ç‚¹å‡» Build æŒ‰é’®ç¼–è¯‘äº†ï¼** ğŸ‰


