# 触摸功能测试指南

## 功能说明

本模块实现了GPIO13的电容触摸检测功能，当检测到触摸时：
1. 显示器显示开心（happy）表情
2. 向AI发送消息："我被摸头了，好开心"
3. 实现2秒防抖动，避免重复触发

## 硬件连接

1. 从ESP32-S3的**GPIO13**引脚引出一根导线
2. 将导线连接到触摸电极（建议使用铝箔、铜片等导电材料）
3. 触摸电极尺寸建议：2cm x 2cm 或更大
4. 导线长度建议：不超过20cm（避免引入噪声）

## 编译和烧录

```bash
cd /Users/machenyang/Desktop/xiaozhi-esp32-main

# 编译项目
idf.py build

# 烧录到设备
idf.py flash

# 查看串口日志
idf.py monitor
```

## 测试步骤

### 1. 基础功能测试

**测试目标**：验证触摸检测是否正常工作

**操作步骤**：
1. 确保设备已连接WiFi并完成初始化
2. 用手指触摸连接到GPIO13的电极
3. 观察以下现象：

**预期结果**：
- ✅ 串口输出：`TouchHandler: Touch detected! Value: XXX, Threshold: XXX`
- ✅ 串口输出：`Application: Touch detected! Responding with happy emotion and sending message to AI`
- ✅ 屏幕显示：happy表情（😊）
- ✅ AI回复：对"我被摸头了，好开心"的响应

### 2. 防抖动测试

**测试目标**：验证2秒防抖动功能

**操作步骤**：
1. 快速连续触摸电极3次（间隔小于1秒）
2. 观察触发次数

**预期结果**：
- ✅ 只有第一次触摸触发响应
- ✅ 串口输出：`Touch ignored (debounce): XXXX us since last touch`
- ✅ 2秒后再次触摸，正常触发

### 3. 多状态测试

**测试目标**：验证在不同设备状态下的触摸响应

**测试场景A - 空闲状态**：
1. 设备处于待机状态
2. 触摸电极

**预期结果**：
- ✅ 显示happy表情
- ✅ 如果没有活动通道，尝试打开通道并发送消息

**测试场景B - 对话中触摸**：
1. 正在与AI对话
2. 触摸电极

**预期结果**：
- ✅ 显示happy表情
- ✅ 通过活动通道发送消息给AI
- ✅ AI收到并做出反应

**测试场景C - 播放音频时触摸**：
1. AI正在播放语音
2. 触摸电极

**预期结果**：
- ✅ 显示happy表情
- ✅ 记录日志但不打断当前状态

## 关键日志信息

启动时应看到：
```
I (XXXX) Application: Initializing touch handler on GPIO13...
I (XXXX) TouchHandler: Initializing touch sensor on GPIO13 (TOUCH_PAD_NUM5)
I (XXXX) TouchHandler: Touch sensor initialized - Baseline: XXXX, Threshold: XXXX
I (XXXX) TouchHandler: Touch detection task started on CPU1
I (XXXX) TouchHandler: Touch handler started successfully
```

触摸时应看到：
```
I (XXXX) TouchHandler: Touch detected! Value: XXXX, Threshold: XXXX
I (XXXX) Application: Touch detected! Responding with happy emotion and sending message to AI
I (XXXX) Application: Sent touch message to AI
```

## 故障排查

### 问题1：触摸无响应

**可能原因**：
- 触摸阈值设置不合适
- 电极面积太小
- 导线太长引入干扰

**解决方案**：
1. 查看串口日志中的Baseline和Threshold值
2. 触摸时观察实际的Value值
3. 如果Value一直大于Threshold，需要调整阈值
4. 修改`touch_handler.cc`中的`TOUCH_THRESH_PERCENT`（默认80%）

### 问题2：触摸太灵敏（误触发）

**解决方案**：
1. 降低触摸阈值（提高`TOUCH_THRESH_PERCENT`到85%或90%）
2. 减小电极面积
3. 缩短连接线长度

### 问题3：防抖动时间不合适

**解决方案**：
- 修改`touch_handler.cc`中的`DEBOUNCE_TIME_US`
- 默认2秒（2000000微秒）
- 可以改为1秒（1000000）或3秒（3000000）

### 问题4：编译错误

**常见错误**：
```
undefined reference to touch_pad_xxx
```

**解决方案**：
- 确保使用ESP32-S3芯片（其他芯片可能不支持触摸功能）
- 检查sdkconfig中是否启用了触摸传感器驱动

## 技术参数

- **检测通道**：TOUCH_PAD_NUM5（GPIO13）
- **运行核心**：CPU1
- **任务优先级**：5
- **栈大小**：4096字节
- **轮询间隔**：50ms
- **防抖时间**：2秒
- **触摸阈值**：基准值的80%
- **电压配置**：HVOLT_2V7, LVOLT_0V5, ATTEN_1V
- **滤波模式**：IIR_16

## 性能影响

- **CPU占用**：<5%（CPU1）
- **内存占用**：~4KB（任务栈）
- **对音频影响**：无（运行在CPU1，音频输入在CPU0）
- **响应延迟**：<100ms

## 扩展建议

1. **多点触摸**：可以添加更多GPIO作为触摸点
2. **长按检测**：可以区分短触和长按
3. **触摸强度**：根据触摸值判断触摸力度
4. **触摸音效**：添加触摸反馈音效

## 注意事项

⚠️ **安全提示**：
- GPIO13连接的导线不要过长，避免静电损坏
- 不要在高压环境下使用
- 确保触摸电极绝缘良好，避免短路

⚠️ **调试提示**：
- 首次使用时建议在串口监视器中观察Baseline和实际触摸Value
- 根据实际情况调整阈值参数
- 如果环境变化大（如温度、湿度），可能需要重新校准

## 成功标准

✅ 所有测试通过的标志：
1. 触摸响应及时（<100ms）
2. 表情正确显示（happy）
3. AI收到并回复消息
4. 防抖动正常工作（2秒内不重复触发）
5. 不影响其他功能（音频、对话等）

祝测试顺利！🎉








