# 重复定义修复说明

## 问题描述

编译时出现以下错误：
1. **头文件重复定义**：`UserProfileData`, `UserProfile`, `AdaptiveBehavior`, `EmotionalMemoryData`, `EmotionalMemory` 等类/结构体被定义了两次
2. **源文件重复定义**：`pet_system.cc` 和 `application.cc` 中的函数被定义了两次
3. **头文件语法错误**：`pet_system.h` 出现 `#endif without #if` 错误

## 根本原因

所有受影响的文件都有**完整的内容重复**：
- 文件的后半部分是前半部分的完全拷贝
- 这导致每个类/函数被定义两次，引发编译错误

## 修复方法

### 1. 修复头文件重复
删除了以下文件中的重复内容：

#### `/main/learning/user_profile.h`
- **保留行数**：1-140 行
- **删除内容**：第 143-285 行（重复的结构体和类定义）

#### `/main/learning/adaptive_behavior.h`
- **保留行数**：1-155 行
- **删除内容**：第 156-307 行（重复的类定义）

#### `/main/learning/emotional_memory.h`
- **保留行数**：1-174 行
- **删除内容**：第 175-345 行（重复的结构体和类定义）

#### `/main/pet_system.h`
- **保留行数**：1-259 行
- **删除内容**：第 260-266 行（重复的末尾代码）

### 2. 修复源文件重复

#### `/main/pet_system.cc`
- **保留行数**：1-927 行
- **删除内容**：第 928-1084 行（孤立的代码片段和重复的函数定义）
- **问题**：第 928 行开始出现了没有函数签名的 cJSON 代码，导致语法错误

#### `/main/application.cc`
- **保留行数**：1-1039 行
- **删除内容**：第 1040-1116 行（孤立的代码片段和重复的函数定义）
- **问题**：第 1040 行开始出现了孤立的 `protocol_->SendWakeWordDetected(wake_word);` 调用

#### `/main/mcp_server.cc`
- **保留行数**：1-781 行
- **删除内容**：第 783-804 行（孤立的代码片段和重复的函数定义）
- **问题**：第 783 行开始出现了孤立的 `ESP_LOGE` 调用

#### `/main/learning/adaptive_behavior.cc`
- **保留行数**：1-303 行
- **删除内容**：第 304-605 行（完整的重复代码）

#### `/main/learning/emotional_memory.cc`
- **保留行数**：1-337 行
- **删除内容**：第 338-673 行（完整的重复代码）

#### `/main/learning/user_profile.cc`
- **保留行数**：1-265 行
- **删除内容**：第 266-527 行（完整的重复代码）

### 3. 修复 CMakeLists.txt
删除了 `/main/CMakeLists.txt` 中的重复代码块（第 832-850 行）

## 修复结果

### 修复前的错误
```
error: redefinition of 'struct xiaozhi::UserProfileData'
error: redefinition of 'class xiaozhi::UserProfile'
error: redefinition of 'class xiaozhi::AdaptiveBehavior'
error: redefinition of 'struct xiaozhi::EmotionalMemoryData'
error: redefinition of 'class xiaozhi::EmotionalMemory'
error: redefinition of 'std::string PetSystem::GetPetTypeInfo(...)'
error: redefinition of 'void PetSystem::SetWarningCallback(...)'
error: redefinition of 'std::string PetSystem::CheckWarning()'
error: redefinition of 'void PetSystem::CheckAndNotifyWarnings()'
error: redefinition of 'bool Application::CanEnterSleepMode()'
error: redefinition of 'void Application::SendMcpMessage(...)'
error: redefinition of 'void Application::SetAecMode(...)'
error: redefinition of 'void Application::PlaySound(...)'
error: #endif without #if
error: expected declaration before '}' token
```

### 修复后
✅ 所有类/结构体定义只出现一次  
✅ 所有函数定义只出现一次  
✅ 头文件语法正确，include guards 正常工作  
✅ 可以正常编译

## 验证

使用以下命令验证修复结果：

```bash
# 验证头文件中的类定义只出现一次
grep -n "^struct UserProfileData\|^class UserProfile\|^class AdaptiveBehavior\|^struct EmotionalMemoryData\|^class EmotionalMemory" main/learning/*.h

# 预期输出（每个类/结构体只出现一次）：
# main/learning/adaptive_behavior.h:14:class AdaptiveBehavior {
# main/learning/emotional_memory.h:12:struct EmotionalMemoryData {
# main/learning/emotional_memory.h:46:class EmotionalMemory {
# main/learning/user_profile.h:12:struct UserProfileData {
# main/learning/user_profile.h:60:class UserProfile {
```

## 可能的原因

这种大规模的内容重复可能是由以下原因造成的：
1. **编辑器故障**：复制粘贴时出现错误
2. **版本控制合并冲突**：git merge 时处理不当
3. **文件损坏**：编辑时意外追加了重复内容

## 下一步

1. ✅ 修复重复定义
2. ⏭️ 使用 VSCode 的 "Build" 功能重新编译
3. ⏭️ 如果编译成功，使用 "Build, Flash and Monitor" 烧录到设备

## 注意事项

- 所有修复都是**删除重复内容**，不涉及逻辑修改
- 头文件的 `#pragma once` 指令可以防止头文件被多次包含，但无法防止**文件内部的重复定义**
- 建议在 git 中提交这些修复，避免后续再次出现类似问题

