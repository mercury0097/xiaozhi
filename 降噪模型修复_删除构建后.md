# ğŸ”§ é™å™ªæ¨¡å‹ä¿®å¤ - åˆ é™¤æ„å»ºåæ¢å¤

## âŒ é—®é¢˜ç—‡çŠ¶

åˆ é™¤æ„å»ºç›®å½•åï¼Œè®¾å¤‡æ—¥å¿—æ˜¾ç¤ºï¼š

```
W (19953) AfeAudioProcessor: âš ï¸  æœªæ‰¾åˆ° vadnet1_mediumï¼Œå°è¯• vadnet1...
W (19963) AfeAudioProcessor: âš ï¸  æœªæ‰¾åˆ° vadnet1ï¼Œå°è¯• vadn1_medium...
W (19983) AfeAudioProcessor: âš ï¸  æœªæ‰¾åˆ°ä»»ä½• VADNet æ¨¡å‹
I (20003) AFE: AFE Pipeline: [input] -> |NS(nsnet2)| -> |AGC(WebRTC)| -> |VAD(WebRTC)| -> [output]
```

**VAD åˆå›åˆ°äº† WebRTC æ¨¡å¼**ï¼Œè€Œä¸æ˜¯ç¥ç»ç½‘ç»œæ¨¡å¼ï¼

---

## ğŸ” é—®é¢˜åŸå› 

åˆ é™¤ `build/` ç›®å½•åï¼š
1. âœ… **VADNet1 è¡¥ä¸** å·²ç»é‡æ–°åº”ç”¨ï¼ˆè‡ªåŠ¨è„šæœ¬å·²æ‰§è¡Œï¼‰
2. âŒ **srmodels.bin** è¢«åˆ é™¤ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆ
3. âŒ **model åˆ†åŒº** æ²¡æœ‰æœ€æ–°çš„æ¨¡å‹æ–‡ä»¶

---

## âœ… å·²ä¿®å¤å†…å®¹

### 1. VADNet1 è¡¥ä¸å·²æ¢å¤
```bash
âœ… è¡¥ä¸å·²é‡æ–°åº”ç”¨ï¼
```

æ£€æŸ¥ç¡®è®¤ï¼š
```bash
$ grep "Clear old static_srmodels cache" managed_components/espressif__esp-sr/src/model_path.c
        printf("[PATCH] Clear old static_srmodels cache before loading from Flash\n");
```

---

## ğŸš€ å®Œæ•´ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1ï¼šåœ¨ VSCode ä¸­ç¼–è¯‘

ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ **ğŸ”¨ Build** æŒ‰é’®

è¿™ä¼šï¼š
- âœ… é‡æ–°ç”Ÿæˆ `build/srmodels/srmodels.bin`ï¼ˆåŒ…å« vadnet1_mediumï¼‰
- âœ… åº”ç”¨ VADNet1 è¡¥ä¸ï¼ˆå·²å®Œæˆï¼‰
- âœ… ç¼–è¯‘æ‰€æœ‰ä»£ç 

### æ­¥éª¤ 2ï¼šå®Œæ•´çƒ§å½•

**é‡è¦**ï¼šåˆ é™¤æ„å»ºåï¼Œéœ€è¦çƒ§å½•æ‰€æœ‰åˆ†åŒºï¼

ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ **âš¡ Build, Flash and Monitor** æŒ‰é’®

æˆ–è€…åœ¨ç»ˆç«¯ä¸­ï¼š
```bash
idf.py flash monitor
```

**ä¸è¦åªçƒ§å½• app åˆ†åŒº**ï¼Œå› ä¸º `srmodels.bin` ä¹Ÿéœ€è¦é‡æ–°çƒ§å½•åˆ° `model` åˆ†åŒºï¼

### æ­¥éª¤ 3ï¼šéªŒè¯æˆåŠŸ

è®¾å¤‡å¯åŠ¨åï¼Œæ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š

```
I (xxx) AfeAudioProcessor: âœ… ESP-SR åŠ è½½çš„æ¨¡å‹æ•°é‡: 4
I (xxx) AfeAudioProcessor:    ESP-SR æ¨¡å‹ 0: nsnet1
I (xxx) AfeAudioProcessor:    ESP-SR æ¨¡å‹ 1: wn9_nihaoxiaozhi_tts
I (xxx) AfeAudioProcessor:    ESP-SR æ¨¡å‹ 2: nsnet2
I (xxx) AfeAudioProcessor:    ESP-SR æ¨¡å‹ 3: vadnet1_medium  âœ…
I (xxx) AfeAudioProcessor: ğŸ” æŒ‡å®š VAD æ¨¡å‹: vadnet1_medium (ç¥ç»ç½‘ç»œ), æ‰¾åˆ°: vadnet1_medium  âœ…
I (xxx) AFE: AFE Pipeline: [input] -> |NS(nsnet2)| -> |AGC(WebRTC)| -> |VAD(vadnet1_medium)| -> [output]  âœ…
```

---

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

åˆ é™¤æ„å»ºåï¼Œå¿…é¡»ç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š

- [x] **VADNet1 è¡¥ä¸å·²åº”ç”¨**ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰
  ```bash
  bash apply_vadnet1_fix.sh
  # è¾“å‡ºï¼šâœ… è¡¥ä¸å·²é‡æ–°åº”ç”¨ï¼
  ```

- [ ] **é‡æ–°ç¼–è¯‘**
  - VSCode: ç‚¹å‡» ğŸ”¨ **Build**
  - ç»ˆç«¯: `idf.py build`

- [ ] **å®Œæ•´çƒ§å½•**ï¼ˆåŒ…æ‹¬ model åˆ†åŒºï¼‰
  - VSCode: ç‚¹å‡» âš¡ **Build, Flash and Monitor**
  - ç»ˆç«¯: `idf.py flash monitor`

- [ ] **éªŒè¯æ—¥å¿—**
  ```
  ESP-SR æ¨¡å‹ 3: vadnet1_medium  âœ…
  VAD(vadnet1_medium)  âœ…
  ```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å®Œæ•´çƒ§å½•ï¼Ÿ

### åˆ†åŒºè¯´æ˜

ESP32 æœ‰å¤šä¸ªåˆ†åŒºï¼š
- **app** åˆ†åŒºï¼šå­˜æ”¾åº”ç”¨ç¨‹åºä»£ç ï¼ˆxiaozhi.binï¼‰
- **model** åˆ†åŒºï¼šå­˜æ”¾ ESP-SR æ¨¡å‹ï¼ˆsrmodels.binï¼‰
- **bootloader** åˆ†åŒºï¼šå¼•å¯¼åŠ è½½ç¨‹åº

### åˆ é™¤æ„å»ºçš„å½±å“

| æ–‡ä»¶ | ä½ç½® | åˆ é™¤åçŠ¶æ€ | éœ€è¦é‡æ–°çƒ§å½• |
|------|------|----------|------------|
| `xiaozhi.bin` | build/ | âŒ åˆ é™¤ | âœ… æ˜¯ï¼ˆappåˆ†åŒºï¼‰ |
| `srmodels.bin` | build/srmodels/ | âŒ åˆ é™¤ | âœ… æ˜¯ï¼ˆmodelåˆ†åŒºï¼‰ |
| VADNet1 è¡¥ä¸ | managed_components/ | âœ… ä¿ç•™ | âŒ å¦ï¼ˆä»£ç çº§ä¿®å¤ï¼‰ |

### VSCode é»˜è®¤çƒ§å½•è¡Œä¸º

- **âš¡ Flash**ï¼šåªçƒ§å½• app åˆ†åŒºï¼ˆä¸å¤Ÿï¼ï¼‰
- **âš¡ Build, Flash and Monitor**ï¼šçƒ§å½•æ‰€æœ‰åˆ†åŒºï¼ˆæ¨èï¼ï¼‰

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç¼–è¯‘åä»ç„¶æ²¡æœ‰ vadnet1_medium

**æ£€æŸ¥**ï¼š
```bash
ls -lh build/srmodels/srmodels.bin
```

å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–å¾ˆå°ï¼ˆ<200KBï¼‰ï¼Œè¯´æ˜æ¨¡å‹æ²¡æœ‰è¢«æ­£ç¡®æ‰“åŒ…ã€‚

**è§£å†³**ï¼š
```bash
# æ‰‹åŠ¨è§¦å‘æ¨¡å‹ç”Ÿæˆ
cd build
ninja srmodels
```

### é—®é¢˜ 2ï¼šçƒ§å½•åä»ç„¶æ‰¾ä¸åˆ°æ¨¡å‹

**æ£€æŸ¥**ï¼šè®¾å¤‡æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
```
I (xxx) AfeAudioProcessor: ğŸ“¦ Flash ä¸­çš„æ¨¡å‹æ•°é‡: 3
```

å¦‚æœåªæœ‰ 3 ä¸ªæ¨¡å‹ï¼Œè¯´æ˜ model åˆ†åŒºæ²¡æœ‰è¢«æ­£ç¡®çƒ§å½•ã€‚

**è§£å†³**ï¼š
```bash
# æ‰‹åŠ¨çƒ§å½• model åˆ†åŒº
esptool.py --port /dev/tty.usbmodem101 write_flash 0x800000 build/srmodels/srmodels.bin
```

### é—®é¢˜ 3ï¼šè¡¥ä¸åˆæ¶ˆå¤±äº†

**åŸå› **ï¼šESP-IDF çš„ `idf.py fullclean` æˆ–æŸäº›æ“ä½œä¼šé‡ç½® managed_components

**è§£å†³**ï¼š
```bash
bash apply_vadnet1_fix.sh
```

---

## ğŸ“‹ å®Œæ•´æ“ä½œæµç¨‹

### æƒ…å†µ Aï¼šç¬¬ä¸€æ¬¡åˆ é™¤æ„å»ºå

```bash
# 1. ç¡®è®¤è¡¥ä¸ï¼ˆå·²è‡ªåŠ¨åº”ç”¨ï¼‰
bash apply_vadnet1_fix.sh

# 2. VSCode ç¼–è¯‘
ç‚¹å‡» ğŸ”¨ Build

# 3. å®Œæ•´çƒ§å½•
ç‚¹å‡» âš¡ Build, Flash and Monitor
```

### æƒ…å†µ Bï¼šå¦‚æœå‡ºç°ä¸²å£å ç”¨

```bash
# 1. é‡Šæ”¾ä¸²å£
bash é‡Šæ”¾ä¸²å£.sh

# 2. é‡æ–°çƒ§å½•
ç‚¹å‡» âš¡ Flash
```

---

## âœ… æˆåŠŸæ ‡å¿—

è®¾å¤‡å¯åŠ¨åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
I (xxx) AfeAudioProcessor: âœ… ESP-SR åŠ è½½çš„æ¨¡å‹æ•°é‡: 4
I (xxx) AfeAudioProcessor:    ESP-SR æ¨¡å‹ 3: vadnet1_medium
I (xxx) AfeAudioProcessor: ğŸ” æŒ‡å®š VAD æ¨¡å‹: vadnet1_medium (ç¥ç»ç½‘ç»œ), æ‰¾åˆ°: vadnet1_medium
I (xxx) AFE: AFE Pipeline: [input] -> |NS(nsnet2)| -> |AGC(WebRTC)| -> |VAD(vadnet1_medium)| -> [output]

MC Quantized vadnet1:vadnet1_mediumv1_Speech_1_0.5_0.1, min speech:128 ms, min noise:64 ms, mode:3...
```

**å…³é”®å­—**ï¼š
- âœ… `vadnet1_medium` åœ¨æ¨¡å‹åˆ—è¡¨ä¸­
- âœ… `VAD(vadnet1_medium)` åœ¨ç®¡é“ä¸­
- âœ… `MC Quantized vadnet1` åˆå§‹åŒ–æ—¥å¿—

---

**ä¿®å¤çŠ¶æ€**: âœ… è¡¥ä¸å·²æ¢å¤  
**ä¸‹ä¸€æ­¥**: åœ¨ VSCode ä¸­ç¼–è¯‘å¹¶å®Œæ•´çƒ§å½•  
**é¢„è®¡æ—¶é—´**: 5-8 åˆ†é’Ÿï¼ˆç¼–è¯‘ 3-5 åˆ†é’Ÿ + çƒ§å½• 1-2 åˆ†é’Ÿï¼‰

**é‡è¦æç¤º**ï¼šåˆ é™¤æ„å»ºåï¼Œä¸€å®šè¦å®Œæ•´çƒ§å½•æ‰€æœ‰åˆ†åŒºï¼Œä¸èƒ½åªçƒ§å½• appï¼

